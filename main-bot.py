import asyncio,json
import discord,os
from discord.ext import commands,tasks
from gemas import function_gemas
import datetime
from discord import app_commands

from dotenv import load_dotenv
load_dotenv()

TOKEN = os.getenv('token')
DISCORD_CHANNEL = int(os.getenv('discord_channel_id'))
PATH_MAIN = os.getenv('main_path_accounts')


bot = commands.Bot(command_prefix='>',
                   description='Prefix: >\nStumble Guys Api',
                   activity=discord.Activity(type=discord.ActivityType.playing,
                                             name="Stumble Guys"),
                   status=discord.Status.idle,intents=discord.Intents.all())

async def load():
    for filename in os.listdir('./cogs'):
        if filename.endswith('.py'):
            await bot.load_extension(f'cogs.{filename[:-3]}')

@bot.event
async def on_ready():
    print(f"Bot {bot.user.name} online")
    try:
        synced = await bot.tree.sync()
        print(f"Synced {len(synced)} commands(s)")
    except Exception as e:
        print(e)
       
    Stumble_Gemas.start()

@bot.tree.command(name = "teste", description = "Slash comando teste")
async def first_command(interaction: discord.Interaction):
    await interaction.response.send_message("Testado!")

json_contas = open(PATH_MAIN,"r")
contas = json.load(json_contas)


@tasks.loop(hours = 4)#4 horas14400
async def Stumble_Gemas():
    print(f"[{datetime.datetime.now()}]Stumble guys task")
    index = [n for n in range(len(contas))] #for loop to get all acccounts in contas.json file
    
    channel = bot.get_channel(DISCORD_CHANNEL)
    try:
        for conta in index:
            a_conta = contas['contas'][conta]
            print(contas['contas'][conta]['Usuario'])
            await function_gemas(str(a_conta),await channel.send(content=contas['contas'][conta]['Usuario'], embed=discord.Embed(color=0xA020F0 ,title="Iniciando ðŸ“¡",description="Processo para resgatar premiaÃ§Ãµes a cada 4 horas")))

    except Exception as r:
        print(r)


async def main():
    await load()
    await bot.start(TOKEN)
 


asyncio.run(main())
