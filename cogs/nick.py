from ast import Str
import discord,json,requests,hashlib,os
from discord.ext import commands
from time import time
import time as tm



#carregar variaveis env 
from dotenv import load_dotenv
load_dotenv()

USER_LOGIN = os.getenv('user_login')
KEY = os.getenv('key')
USER_EDIT = os.getenv('user_edit')
PATH_COGS = os.getenv('path_accounts')
#-----------------------

class Nick(commands.Cog):
    def __init__(self,bot):
        self.bot = bot

    @commands.command()
    async def nick(self,ctx,numero:int,nick:str):
                
        json_contas = open(PATH_COGS,"r")
        contas = json.load(json_contas)
        json_contas.close()
        
        if len(contas['contas']) < numero:
            print(len(contas['contas']))
            await ctx.send(embed=discord.Embed(color=0xA020F0, description=f"Tem certeza que esse n√∫mero est√° na lista de contas?"))
            return False
        
        if len(nick) > 12:
            await ctx.send(embed=discord.Embed(color=0xA020F0, description=f"{nick} possue {len(nick)} caracteres, apenas nicks menores de 12 caracteres s√£o permitidos"))
            return False
        
        data = f"{contas['contas'][numero-1]}"
        headers = {
        'Content-Type': 'application/json',
        'use_response_compression': 'true',
        'Host': 'kitkabackend.eastus.cloudapp.azure.com:5010',}
        r = requests.post(USER_LOGIN, headers=headers,data=data)
        if r.status_code == 403 or r.status_code == 404 or r.status_code == 400 or r.text == "BANNED":
            await ctx.send(embed=discord.Embed(color=0xA020F0, title="N√£o foi poss√≠vel logar",description=f"{r.text}"))
        
        auth_header = {'DeviceId': r.json()['User']['DeviceId'], 'GoogleId': '', 'FacebookId': '', 'AppleId': '', 'Token': r.json()['User']['Token'], 'Timestamp': 1657411202, 'Hash': '128053146036d1bfcda08eedcc177bb625f90bb1', 'Facebook': None}

        data = str({"Username":nick})
        auth = hashstumble(auth_header,'/user/update',data)
        headers = {
        'Content-Type': 'application/json',
        'authorization': str(auth),
        'use_response_compression': 'false',
        'Host': 'kitkabackend.eastus.cloudapp.azure.com:5010',}
    
        r = requests.post(USER_EDIT, headers=headers,data=data)
        if r.status_code == 403 or r.status_code == 404 or r.text == "BANNED":
            await ctx.send(embed=discord.Embed(color=0xA020F0, title="N√£o foi poss√≠vel continuar",description=f"{r.text}"))
        
        resposta = f"Nome da conta numero **{numero}** alterado para **{r.json()['User']['Username']}**" if r.status_code == 200 else f"Nick n√£o alterado por algum erro desconhecido\nü§ñLog:`{r.text}`"
        
        await ctx.send(embed=discord.Embed(color=0xA020F0, title="Nick",description=f"{resposta}").set_footer(text="Stringoff - Account Management - Por Dasw", icon_url='https://i.pinimg.com/564x/7c/e1/fe/7ce1feb183febb3dfbd56753b1f1cea9.jpg'))


async def setup(bot):
    await bot.add_cog(Nick(bot))

def hashstumble(auth,url_pam,json):
    key = KEY
    ts = int(time())
    a = ''
    data = f'{json}'
    hash1 = f"{key}{auth['DeviceId']}{auth['GoogleId']}{auth['Token']}{str(ts)}{url_pam}{data}"
    json  = {"DeviceId":auth['DeviceId'],"GoogleId":auth['GoogleId'],"FacebookId":"","AppleId":"","Token":auth['Token'],"Timestamp":ts,"Hash":hashlib.sha1(bytes(a.join(hash1), 'utf-8')).hexdigest()}
    return str(json)